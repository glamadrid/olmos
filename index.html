<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Jayanca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100vw; }
    .popup-content img { max-width: 100%; height: auto; display: block; margin: 5px 0; }
    .popup-content audio, video { width: 100%; margin: 5px 0; }
    .carousel-controls { text-align: center; margin: 5px 0; }
    .carousel-controls button {
      background: #eee; border: none; padding: 5px 8px;
      margin: 0 5px; border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([-6.046, -79.758], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Pol√≠gonos
    L.polygon([
      [-6.041930, -79.744010],
      [-6.050974, -79.743989],
      [-6.051036, -79.771093],
      [-6.041992, -79.771113]
    ], {
      color: '#0000ff', fillColor: '#00ff00', fillOpacity: 0.4
    }).addTo(map).bindPopup('<b>Arianna 4</b><br>√Årea: 300 ha');

    L.polygon([
      [-6.036191, -79.746322],
      [-6.045236, -79.746302],
      [-6.045277, -79.764370],
      [-6.036233, -79.764391]
    ], {
      color: '#ffcc00', fillColor: '#ff0000', fillOpacity: 0.4
    }).addTo(map).bindPopup('<b>FUEGO N¬∫4</b><br>√Årea: 200 ha');

    // URL de Google Sheets en CSV
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHLS2rYQc7iCFWdIPXRESfwAxPqJCfnfd39t6z6ppfeAP9DdQYPLPsoCjbM9y-K8zsGdPfOvBSeVGp/pub?gid=0&single=true&output=csv";

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach((item) => {
          const lat = parseFloat(item.latitud);
          const lon = parseFloat(item.longitud);
          if (isNaN(lat) || isNaN(lon)) return;

          let html = `<div class="popup-content">`;
          html += `<h3>${item.titulo || 'Sin t√≠tulo'}</h3>`;
          html += `<p>${item.descripcion || 'Sin descripci√≥n'}</p>`;

          // Fotos
          const fotos = (item.fotos || '').split('|').filter(f => f.trim());
          if (fotos.length > 0) {
            html += `<img src="${fotos[0]}" alt="Foto">`;
            if (fotos.length > 1) {
              html += `<div class="carousel-controls">
                <button onclick="nextFoto(-1)">‚óÄÔ∏è</button>
                <button onclick="nextFoto(1)">‚ñ∂Ô∏è</button>
              </div>`;
            }
          } else {
            html += `<p>üì∑ Sin fotos disponibles.</p>`;
          }

          // Videos
          const videos = (item.videos || '').split('|').filter(v => v.trim());
          if (videos.length > 0) {
            let videoUrl = videos[0];
            if (videoUrl.includes("youtube.com")) {
              const videoId = new URL(videoUrl).searchParams.get("v");
              html += `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
            } else {
              html += `<video controls><source src="${videoUrl}" type="video/mp4"></video>`;
            }
          } else {
            html += `<p>üé• Sin video disponible.</p>`;
          }

          // Audios
          const audios = (item.audios || '').split('|').filter(a => a.trim());
          if (audios.length > 0) {
            html += `<audio controls src="${audios[0]}"></audio>`;
            if (audios.length > 1) {
              html += `<div class="carousel-controls">
                <button onclick="nextAudio(-1)">‚óÄÔ∏è</button>
                <button onclick="nextAudio(1)">‚ñ∂Ô∏è</button>
              </div>`;
            }
          } else {
            html += `<p>üîà Sin notas de voz disponibles.</p>`;
          }

          html += `</div>`;
          const marker = L.marker([lat, lon]).addTo(map);
          marker.bindPopup(html).openPopup();
        });
      }
    });

    // Carruseles (si decides implementar funcionalidad m√∫ltiple)
    let fotoIndex = 0;
    let audioIndex = 0;
    function nextFoto(dir) {
      const imgs = document.querySelectorAll('img#foto');
      if (!imgs.length) return;
      fotoIndex = (fotoIndex + dir + imgs.length) % imgs.length;
      imgs.forEach((img, i) => img.style.display = (i === fotoIndex ? 'block' : 'none'));
    }

    function nextAudio(dir) {
      const audios = document.querySelectorAll('audio#audio');
      if (!audios.length) return;
      audioIndex = (audioIndex + dir + audios.length) % audios.length;
      audios.forEach((a, i) => a.style.display = (i === audioIndex ? 'block' : 'none'));
    }
  </script>
</body>
</html>
