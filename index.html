<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visor de Mapa - Jayanca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    #locate-btn {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: white; border: none; border-radius: 4px;
      padding: 6px 10px; font-size: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map">
    <button id="locate-btn">Mi Ubicaci칩n</button>
  </div>

  <script src="leaflet.js"></script>
  <script src="papaparse.min.js"></script>

  <script>
    var map = L.map('map').setView([-6.046, -79.758], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '춸 OpenStreetMap contributors'
    }).addTo(map);

    // --- POL칈GONO: Arianna 4 ---
    var ariannaCoords = [
      [-6.041930, -79.744010],
      [-6.050974, -79.743989],
      [-6.051036, -79.771093],
      [-6.041992, -79.771113],
      [-6.041930, -79.744010]
    ];

    var ariannaPolygon = L.polygon(ariannaCoords, {
      color: '#0000ff',       // borde azul
      fillColor: '#00ff00',   // relleno verde
      fillOpacity: 0.4        // transparencia del relleno (0 = invisible, 1 = opaco)
    }).addTo(map);
    ariannaPolygon.bindPopup('<b>Arianna 4</b><br>츼rea aproximada: 300 ha.');

    // --- POL칈GONO: FUEGO N췈4 ---
    var fuegoCoords = [
      [-6.036191, -79.746322],
      [-6.045236, -79.746302],
      [-6.045277, -79.764370],
      [-6.036233, -79.764391],
      [-6.036191, -79.746322]
    ];

    var fuegoPolygon = L.polygon(fuegoCoords, {
      color: '#ffcc00',       // borde amarillo
      fillColor: '#ff0000',   // relleno rojo
      fillOpacity: 0.4        // transparencia del relleno
    }).addTo(map);
    fuegoPolygon.bindPopup('<b>FUEGO N췈4</b><br>츼rea aproximada: 200 ha.');

    // --- BOT칍N: Mi Ubicaci칩n ---
    var locateBtn = document.getElementById('locate-btn');
    locateBtn.onclick = function() {
      map.locate({ setView: true, maxZoom: 17 });
    };

    map.on('locationfound', function(e) {
      L.marker(e.latlng).addTo(map)
        .bindPopup("游늸 Usted est치 aqu칤").openPopup();
      L.circle(e.latlng, { radius: e.accuracy || 50 }).addTo(map);
    });

    map.on('locationerror', function() {
      alert("No se pudo obtener su ubicaci칩n");
    });

    // --- Cargar marcadores desde Google Sheets CSV usando PapaParse ---
    var publicSpreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHLS2rYQc7iCFWdIPXRESfwAxPqJCfnfd39t6z6ppfeAP9DdQYPLPsoCjbM9y-K8zsGdPfOvBSeVGp/pub?gid=0&single=true&output=csv";

    Papa.parse(publicSpreadsheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        var data = results.data;
        data.forEach(function(item) {
          if (!item.latitud || !item.longitud) return;
          var lat = parseFloat(item.latitud || item.Latitud);
          var lon = parseFloat(item.longitud || item.Longitud);
          if (isNaN(lat) || isNaN(lon)) return;

          var marker = L.marker([lat, lon]).addTo(map);
          var popup = `<b>${item.titulo || item.Titulo}</b><br>${item.descripcion || ''}`;
          marker.bindPopup(popup);
        });
      }
    });
  </script>
</body>
</html>
