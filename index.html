<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Jayanca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    #locate-btn {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: white; border: none; border-radius: 4px;
      padding: 6px 10px; font-size: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .popup-content img { max-width: 100%; height: auto; display: block; margin: 5px 0; }
    .popup-content audio { width: 100%; margin: 5px 0; }
    .carousel-controls { text-align: center; margin: 5px 0; }
    .carousel-controls button {
      background: #eee; border: none; padding: 5px 8px;
      margin: 0 5px; border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="map">
    <button id="locate-btn">Mi Ubicaci√≥n</button>
  </div>

  <script src="leaflet.js"></script>
  <script src="papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([-6.046, -79.758], 15);

    // Mapa base libre (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Pol√≠gono Arianna 4
    const ariannaCoords = [
      [-6.041930, -79.744010],
      [-6.050974, -79.743989],
      [-6.051036, -79.771093],
      [-6.041992, -79.771113],
      [-6.041930, -79.744010]
    ];
    L.polygon(ariannaCoords, {
      color: '#0000ff', fillColor: '#00ff00', fillOpacity: 0.4
    }).addTo(map).bindPopup('<b>Arianna 4</b><br>√Årea: 300 ha');

    // Pol√≠gono FUEGO N¬∫4
    const fuegoCoords = [
      [-6.036191, -79.746322],
      [-6.045236, -79.746302],
      [-6.045277, -79.764370],
      [-6.036233, -79.764391],
      [-6.036191, -79.746322]
    ];
    L.polygon(fuegoCoords, {
      color: '#ffcc00', fillColor: '#ff0000', fillOpacity: 0.4
    }).addTo(map).bindPopup('<b>FUEGO N¬∫4</b><br>√Årea: 200 ha');

    // Bot√≥n Mi Ubicaci√≥n
    document.getElementById('locate-btn').onclick = function() {
      map.locate({ setView: true, maxZoom: 17 });
    };
    map.on('locationfound', function(e) {
      L.marker(e.latlng).addTo(map).bindPopup("üìç Usted est√° aqu√≠").openPopup();
      L.circle(e.latlng, { radius: e.accuracy || 50 }).addTo(map);
    });
    map.on('locationerror', function() {
      alert("No se pudo obtener su ubicaci√≥n");
    });

    // Marcadores desde Google Sheets con contenido multimedia y nombre visible en zoom 17+
    const publicSpreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHLS2rYQc7iCFWdIPXRESfwAxPqJCfnfd39t6z6ppfeAP9DdQYPLPsoCjbM9y-K8zsGdPfOvBSeVGp/pub?gid=0&single=true&output=csv";
    const markers = [];

    Papa.parse(publicSpreadsheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        data.forEach(item => {
          const lat = parseFloat(item.latitud || item.Latitud);
          const lon = parseFloat(item.longitud || item.Longitud);
          if (!isNaN(lat) && !isNaN(lon)) {
            const marker = L.marker([lat, lon]).addTo(map);
            marker.basePopup = `<b>${item.titulo || item.Titulo}</b><br>`;
            marker.descPopup = buildPopupHTML(item);
            marker.bindPopup(marker.basePopup);
            markers.push(marker);
          }
        });
      }
    });

    function buildPopupHTML(item) {
      let html = '<div class="popup-content">';
      const fotos = (item.fotos || '').split('|').filter(f => f.trim());
      const audios = (item.audios || '').split('|').filter(a => a.trim());
      const videos = (item.videos || '').split('|').filter(v => v.trim());

      if (fotos.length) {
        html += `<img id="foto" src="${fotos[0]}" alt="Foto" />`;
        if (fotos.length > 1) {
          html += '<div class="carousel-controls">';
          html += '<button type="button" onclick="nextFoto(-1)">‚óÄÔ∏è</button>';
          html += '<button type="button" onclick="nextFoto(1)">‚ñ∂Ô∏è</button>';
          html += '</div>';
        }
      }

      if (audios.length) {
        html += `<audio id="audio" controls src="${audios[0]}"></audio>`;
        if (audios.length > 1) {
          html += '<div class="carousel-controls">';
          html += '<button type="button" onclick="nextAudio(-1)">‚óÄÔ∏è</button>';
          html += '<button type="button" onclick="nextAudio(1)">‚ñ∂Ô∏è</button>';
          html += '</div>';
        }
      }

      if (videos.length) {
        const videoUrl = videos[0].includes('youtube.com') ?
          videos[0].replace('watch?v=', 'embed/') : videos[0];
        html += `<iframe width="100%" height="200" src="${videoUrl}" frameborder="0" allowfullscreen></iframe>`;
      }

      html += '</div>';
      return html;
    }

    let fotoIndex = 0;
    let audioIndex = 0;
    function nextFoto(dir) {
      const imgs = document.querySelectorAll('img#foto');
      if (imgs.length === 0) return;
      fotoIndex = (fotoIndex + dir + imgs.length) % imgs.length;
      imgs.forEach((img, i) => img.style.display = (i === fotoIndex) ? 'block' : 'none');
    }
    function nextAudio(dir) {
      const audios = document.querySelectorAll('audio#audio');
      if (audios.length === 0) return;
      audioIndex = (audioIndex + dir + audios.length) % audios.length;
      audios.forEach((audio, i) => audio.style.display = (i === audioIndex) ? 'block' : 'none');
    }

    // Eliminado el filtro por zoom: mostrar siempre toda la informaci√≥n
      markers.forEach(m => {
        m.setPopupContent(m.basePopup + m.descPopup);
      });
    });
  </script>
</body>
</html>
