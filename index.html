<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Jayanca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    #locate-btn {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: white; border: none; border-radius: 4px;
      padding: 6px 10px; font-size: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map">
    <button id="locate-btn">Mi Ubicaci√≥n</button>
  </div>

  <script src="leaflet.js"></script>
  <script src="papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.11.2/Leaflet.GoogleMutant.js"></script>

  <script>
    const map = L.map('map').setView([-6.046, -79.758], 15);

    // ‚úÖ Mapa base de Google (roadmap)
    const googleLayer = L.gridLayer.googleMutant({
      type: 'roadmap' // puedes cambiar a 'satellite', 'hybrid', 'terrain'
    }).addTo(map);

    // ‚úÖ Pol√≠gono Arianna 4
    const ariannaCoords = [
      [-6.041930, -79.744010],
      [-6.050974, -79.743989],
      [-6.051036, -79.771093],
      [-6.041992, -79.771113],
      [-6.041930, -79.744010]
    ];
    const ariannaPolygon = L.polygon(ariannaCoords, {
      color: '#0000ff',       // borde azul
      fillColor: '#00ff00',   // relleno verde
      fillOpacity: 0.4
    }).addTo(map).bindPopup('<b>Arianna 4</b><br>√Årea: 300 ha');

    // ‚úÖ Pol√≠gono FUEGO N¬∫4
    const fuegoCoords = [
      [-6.036191, -79.746322],
      [-6.045236, -79.746302],
      [-6.045277, -79.764370],
      [-6.036233, -79.764391],
      [-6.036191, -79.746322]
    ];
    const fuegoPolygon = L.polygon(fuegoCoords, {
      color: '#ffcc00',       // borde amarillo
      fillColor: '#ff0000',   // relleno rojo
      fillOpacity: 0.4
    }).addTo(map).bindPopup('<b>FUEGO N¬∫4</b><br>√Årea: 200 ha');

    // ‚úÖ Bot√≥n "Mi Ubicaci√≥n"
    document.getElementById('locate-btn').onclick = function() {
      map.locate({ setView: true, maxZoom: 17 });
    };

    map.on('locationfound', function(e) {
      L.marker(e.latlng).addTo(map)
        .bindPopup("üìç Usted est√° aqu√≠").openPopup();
      L.circle(e.latlng, { radius: e.accuracy || 50 }).addTo(map);
    });

    map.on('locationerror', function() {
      alert("No se pudo obtener su ubicaci√≥n");
    });

    // ‚úÖ Marcadores desde Google Sheets CSV
    const publicSpreadsheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHLS2rYQc7iCFWdIPXRESfwAxPqJCfnfd39t6z6ppfeAP9DdQYPLPsoCjbM9y-K8zsGdPfOvBSeVGp/pub?gid=0&single=true&output=csv";

    const markers = [];

    Papa.parse(publicSpreadsheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        data.forEach(item => {
          const lat = parseFloat(item.latitud || item.Latitud);
          const lon = parseFloat(item.longitud || item.Longitud);
          if (!isNaN(lat) && !isNaN(lon)) {
            const marker = L.marker([lat, lon]).addTo(map);
            marker.basePopup = `<b>${item.titulo || item.Titulo}</b><br>`;
            marker.descPopup = item.descripcion || item.Descripcion || '';
            marker.bindPopup(marker.basePopup); // solo t√≠tulo por defecto
            markers.push(marker);
          }
        });
      }
    });

    // ‚úÖ Mostrar descripci√≥n solo cuando el zoom es mayor a 17
    map.on('zoomend', () => {
      const zoom = map.getZoom();
      markers.forEach(m => {
        const fullContent = m.basePopup + (zoom >= 17 ? m.descPopup : '');
        m.setPopupContent(fullContent);
      });
    });
  </script>
</body>
</html>
